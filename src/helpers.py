import pytz
from datetime import datetime, timedelta
import logging
import os

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler(os.getenv("LOG_FILE", "phone_assistant.log"))
    ]
)
log = logging.getLogger("phone_assistant")

def time_of_day_greeting(area_code: str):
    # Get the current time
    current_time = pytz.timezone('America/Los_Angeles').localize(datetime.now()).time()

    # Define the time ranges in America/Los_Angeles time with timezone information
    morning_start           = pytz.timezone('America/Los_Angeles').localize(datetime.strptime('04:00:00', '%H:%M:%S'))
    afternoon_start         = pytz.timezone('America/Los_Angeles').localize(datetime.strptime('12:00:00', '%H:%M:%S'))
    evening_start           = pytz.timezone('America/Los_Angeles').localize(datetime.strptime('17:00:00', '%H:%M:%S'))
    evening_end             = pytz.timezone('America/Los_Angeles').localize(datetime.strptime('23:59:59', '%H:%M:%S'))

    # Adjust the time ranges based on the area code
    if area_code in ['800', '888']:
        morning_start       = (morning_start   + timedelta(hours=3)).time()
        afternoon_start     = (afternoon_start + timedelta(hours=3)).time()
        evening_start       = (evening_start   + timedelta(hours=3)).time()
        evening_end         = (evening_end     + timedelta(hours=3)).time()
    else:
        caller_tz = _area_code_to_timezone(area_code)
        if caller_tz:
            log.debug("Caller is calling from " + str(caller_tz) + ".")
            morning_start   = morning_start.astimezone(caller_tz).time()
            afternoon_start = afternoon_start.astimezone(caller_tz).time()
            evening_start   = evening_start.astimezone(caller_tz).time()
            evening_end     = evening_end.astimezone(caller_tz).time()
        else:
            log.warning("Unable to determine timezone for area code " + area_code + ".")
            return "Hello"

    # Generate the greeting based on the current time
    if morning_start <= current_time < afternoon_start:
        greeting = "Good morning"
    elif afternoon_start <= current_time < evening_start:
        greeting = "Good afternoon"
    elif evening_start <= current_time < evening_end:
        greeting = "Good evening"
    else:
        greeting = "Hello"
    
    return greeting

def _area_code_to_timezone(area_code):
    """
    Converts an area code to a timezone.

    Args:
        area_code (str): The area code to convert.

    Returns:
        str: The timezone corresponding to the area code or None if the area code is not supported.

    Raises: (NOT CURRENTLY IMPLEMENTED)
        ValueError: If the area code is not supported.
    """
    timezones = {
        "201": "America/New_York",
        "202": "America/New_York",
        "203": "America/New_York",
        "204": "America/Winnipeg",
        "205": "America/Chicago",
        "206": "America/Los_Angeles",
        "207": "America/New_York",
        "208": "America/Boise",
        "209": "America/Los_Angeles",
        "210": "America/Chicago",
        "212": "America/New_York",
        "213": "America/Los_Angeles",
        "214": "America/Chicago",
        "215": "America/New_York",
        "216": "America/New_York",
        "217": "America/Chicago",
        "218": "America/Chicago",
        "219": "America/Chicago",
        "224": "America/Chicago",
        "225": "America/Chicago",
        "226": "America/Toronto",
        "228": "America/Chicago",
        "229": "America/New_York",
        "231": "America/New_York",
        "234": "America/New_York",
        "236": "America/Vancouver",
        "239": "America/New_York",
        "240": "America/New_York",
        "248": "America/New_York",
        "250": "America/Vancouver",
        "251": "America/Chicago",
        "252": "America/New_York",
        "253": "America/Los_Angeles",
        "254": "America/Chicago",
        "256": "America/Chicago",
        "260": "America/New_York",
        "262": "America/Chicago",
        "267": "America/New_York",
        "269": "America/New_York",
        "270": "America/Chicago",
        "272": "America/New_York",
        "276": "America/New_York",
        "281": "America/Chicago",
        "289": "America/Toronto",
        
        "301": "America/New_York",
        "302": "America/New_York",
        "303": "America/Denver",
        "304": "America/New_York",
        "305": "America/New_York",
        "306": "America/Regina",
        "307": "America/Denver",
        "308": "America/Chicago",
        "309": "America/Chicago",
        "310": "America/Los_Angeles",
        "312": "America/Chicago",
        "313": "America/New_York",
        "314": "America/Chicago",
        "315": "America/New_York",
        "316": "America/Chicago",
        "317": "America/New_York",
        "318": "America/Chicago",
        "319": "America/Chicago",
        "320": "America/Chicago",
        "321": "America/New_York",
        "323": "America/Los_Angeles",
        "325": "America/Chicago",
        "326": "America/New_York",
        "329": "America/New_York",
        "330": "America/New_York",
        "331": "America/Chicago",
        "332": "America/New_York",
        "334": "America/Chicago",
        "336": "America/New_York",
        "337": "America/Chicago",
        "339": "America/New_York",
        "340": "America/St_Thomas",
        "341": "America/Los_Angeles",
        "343": "America/Toronto",
        "345": "America/Cayman",
        "346": "America/Chicago",
        "347": "America/New_York",
        "350": "America/Los_Angeles",
        "351": "America/New_York",
        "352": "America/New_York",
        "353": "America/Chicago",
        "360": "America/Los_Angeles",
        "361": "America/Chicago",
        "363": "America/New_York",
        "364": "America/Chicago",
        "365": "America/Toronto",
        "369": "America/Los_Angeles",
        "380": "America/New_York",
        "385": "America/Denver",
        "386": "America/New_York",
        
        "401": "America/New_York",
        "402": "America/Chicago",
        "403": "America/Edmonton",
        "404": "America/New_York",
        "405": "America/Chicago",
        "406": "America/Denver",
        "407": "America/New_York",
        "408": "America/Los_Angeles",
        "409": "America/Chicago",
        "410": "America/New_York",
        "412": "America/New_York",
        "413": "America/New_York",
        "414": "America/Chicago",
        "415": "America/Los_Angeles",
        "416": "America/Toronto",
        "417": "America/Chicago",
        "418": "America/Montreal",
        "419": "America/New_York",
        "423": "America/New_York",
        "424": "America/Los_Angeles",
        "425": "America/Los_Angeles",
        "430": "America/Chicago",
        "431": "America/Winnipeg",
        "432": "America/Chicago",
        "434": "America/New_York",
        "435": "America/Denver",
        "437": "America/Toronto",
        "438": "America/Montreal",
        "440": "America/New_York",
        "442": "America/Los_Angeles",
        "443": "America/New_York",
        "445": "America/New_York",
        "447": "America/Chicago",
        "448": "America/Chicago",
        "450": "America/Montreal",
        "458": "America/Los_Angeles",
        "463": "America/New_York",
        "464": "America/Chicago",
        "469": "America/Chicago",
        "470": "America/New_York",
        "472": "America/New_York",
        "475": "America/New_York",
        "478": "America/New_York",
        "479": "America/Chicago",
        "480": "America/Phoenix",
        "484": "America/New_York",

        "501": "America/Chicago",
        "502": "America/New_York",
        "503": "America/Los_Angeles",
        "504": "America/Chicago",
        "505": "America/Denver",
        "506": "America/Moncton",
        "507": "America/Chicago",
        "508": "America/New_York",
        "509": "America/Los_Angeles",
        "510": "America/Los_Angeles",
        "512": "America/Chicago",
        "513": "America/New_York",
        "514": "America/Montreal",
        "515": "America/Chicago",
        "516": "America/New_York",
        "517": "America/New_York",
        "518": "America/New_York",
        "519": "America/Toronto",
        "520": "America/Phoenix",
        "530": "America/Los_Angeles",
        "531": "America/Chicago",
        "534": "America/Chicago",
        "539": "America/Chicago",
        "540": "America/New_York",
        "541": "America/Los_Angeles",
        "548": "America/Toronto",
        "551": "America/New_York",
        "557": "America/Chicago",
        "559": "America/Los_Angeles",
        "561": "America/New_York",
        "562": "America/Los_Angeles",
        "563": "America/Chicago",
        "564": "America/Los_Angeles",
        "567": "America/New_York",
        "570": "America/New_York",
        "571": "America/New_York",
        "572": "America/Chicago",
        "573": "America/Chicago",
        "574": "America/New_York",
        "575": "America/Denver",
        "579": "America/Toronto",
        "580": "America/Chicago",
        "581": "America/Montreal",
        "582": "America/New_York",
        "585": "America/New_York",
        "586": "America/New_York",

        "601": "America/Chicago",
        "602": "America/Phoenix",
        "603": "America/New_York",
        "604": "America/Vancouver",
        "605": "America/Chicago",
        "606": "America/New_York",
        "607": "America/New_York",
        "608": "America/Chicago",
        "609": "America/New_York",
        "610": "America/New_York",
        "612": "America/Chicago",
        "613": "America/Toronto",
        "614": "America/New_York",
        "615": "America/Chicago",
        "616": "America/New_York",
        "617": "America/New_York",
        "618": "America/Chicago",
        "619": "America/Los_Angeles",
        "620": "America/Chicago",
        "623": "America/Phoenix",
        "624": "America/New_York",
        "626": "America/Los_Angeles",
        "628": "America/Los_Angeles",
        "629": "America/Chicago",
        "630": "America/Chicago",
        "631": "America/New_York",
        "636": "America/Chicago",
        "639": "America/Regina",
        "640": "America/New_York",
        "641": "America/Chicago",
        "645": "America/New_York",
        "646": "America/New_York",
        "647": "America/Toronto",
        "649": "America/Grand_Turk",
        "650": "America/Los_Angeles",
        "651": "America/Chicago",
        "656": "America/New_York",
        "657": "America/Los_Angeles",
        "658": "America/Jamaica",
        "659": "America/Chicago",
        "660": "America/Chicago",
        "661": "America/Los_Angeles",
        "662": "America/Chicago",
        "664": "America/Montserrat",
        "667": "America/New_York",
        "669": "America/Los_Angeles",
        "678": "America/New_York",
        "680": "America/New_York",
        "681": "America/New_York",
        "682": "America/Chicago",
        "684": "Pacific/Pago_Pago",
        "689": "America/New_York",

        "701": "America/Chicago",
        "702": "America/Los_Angeles",
        "703": "America/New_York",
        "704": "America/New_York",
        "705": "America/Toronto",
        "706": "America/New_York",
        "707": "America/Los_Angeles",
        "708": "America/Chicago",
        "709": "America/St_Johns",
        "712": "America/Chicago",
        "713": "America/Chicago",
        "714": "America/Los_Angeles",
        "715": "America/Chicago",
        "716": "America/New_York",
        "717": "America/New_York",
        "718": "America/New_York",
        "719": "America/Denver",
        "720": "America/Denver",
        "724": "America/New_York",
        "725": "America/Los_Angeles",
        "726": "America/Chicago",
        "727": "America/New_York",
        "728": "America/New_York",
        "730": "America/Chicago",
        "731": "America/Chicago",
        "732": "America/New_York",
        "734": "America/New_York",
        "737": "America/Chicago",
        "740": "America/New_York",
        "743": "America/New_York",
        "747": "America/Los_Angeles",
        "754": "America/New_York",
        "757": "America/New_York",
        "758": "America/St_Lucia",
        "760": "America/Los_Angeles",
        "762": "America/New_York",
        "763": "America/Chicago",
        "765": "America/New_York",
        "767": "America/Dominica",
        "769": "America/Chicago",
        "770": "America/New_York",
        "771": "America/New_York",
        "772": "America/New_York",
        "773": "America/Chicago",
        "774": "America/New_York",
        "775": "America/Los_Angeles",
        "778": "America/Vancouver",
        "779": "America/Chicago",
        "780": "America/Edmonton",
        "781": "America/New_York",
        "782": "America/Halifax",
        "784": "America/St_Vincent",
        "785": "America/Chicago",
        "786": "America/New_York",
        "787": "America/Puerto_Rico",

        "801": "America/Denver",
        "802": "America/New_York",
        "803": "America/New_York",
        "804": "America/New_York",
        "805": "America/Los_Angeles",
        "806": "America/Chicago",
        "807": "America/Winnipeg",
        "808": "Pacific/Honolulu",
        "809": "America/Santo_Domingo",
        "810": "America/New_York",
        "812": "America/New_York",
        "813": "America/New_York",
        "814": "America/New_York",
        "815": "America/Chicago",
        "816": "America/Chicago",
        "817": "America/Chicago",
        "818": "America/Los_Angeles",
        "819": "America/Montreal",
        "820": "America/Los_Angeles",
        "825": "America/Edmonton",
        "826": "America/New_York",
        "828": "America/New_York",
        "829": "America/Santo_Domingo",
        "830": "America/Chicago",
        "831": "America/Los_Angeles",
        "832": "America/Chicago",
        "835": "America/New_York",
        "838": "America/New_York",
        "839": "America/New_York",
        "840": "America/Los_Angeles",
        "843": "America/New_York",
        "845": "America/New_York",
        "847": "America/Chicago",
        "848": "America/New_York",
        "849": "America/Santo_Domingo",
        "850": "America/Chicago",
        "854": "America/New_York",
        "856": "America/New_York",
        "857": "America/New_York",
        "858": "America/Los_Angeles",
        "859": "America/New_York",
        "860": "America/New_York",
        "861": "America/Chicago",
        "862": "America/New_York",
        "863": "America/New_York",
        "864": "America/New_York",
        "865": "America/New_York",
        "867": "America/Yellowknife",
        "868": "America/Port_of_Spain",
        "869": "America/St_Kitts",
        "870": "America/Chicago",
        "872": "America/Chicago",
        "873": "America/Toronto",
        "876": "America/Jamaica",
        "878": "America/New_York",

        "901": "America/Chicago",
        "902": "America/Halifax",
        "903": "America/Chicago",
        "904": "America/New_York",
        "905": "America/Toronto",
        "906": "America/New_York",
        "907": "America/Anchorage",
        "908": "America/New_York",
        "909": "America/Los_Angeles",
        "910": "America/New_York",
        "912": "America/New_York",
        "913": "America/Chicago",
        "914": "America/New_York",
        "915": "America/Denver",
        "916": "America/Los_Angeles",
        "917": "America/New_York",
        "918": "America/Chicago",
        "919": "America/New_York",
        "920": "America/Chicago",
        "925": "America/Los_Angeles",
        "928": "America/Phoenix",
        "929": "America/New_York",
        "930": "America/New_York",
        "931": "America/Chicago",
        "934": "America/New_York",
        "936": "America/Chicago",
        "937": "America/New_York",
        "938": "America/Chicago",
        "939": "America/Puerto_Rico",
        "940": "America/Chicago",
        "941": "America/New_York",
        "943": "America/New_York",
        "945": "America/Chicago",
        "947": "America/New_York",
        "948": "America/New_York",
        "949": "America/Los_Angeles",
        "951": "America/Los_Angeles",
        "952": "America/Chicago",
        "954": "America/New_York",
        "956": "America/Chicago",
        "959": "America/New_York",
        "970": "America/Denver",
        "971": "America/Los_Angeles",
        "972": "America/Chicago",
        "973": "America/New_York",
        "975": "America/Chicago",
        "978": "America/New_York",
        "979": "America/Chicago",
        "980": "America/New_York",
        "983": "America/Denver",
        "984": "America/New_York",
        "985": "America/Chicago",
        "986": "America/Denver",
        "989": "America/New_York"
    }

    if area_code in timezones:
        return pytz.timezone(timezones[area_code])
    else:
        print("Area code not supported.")
        return None